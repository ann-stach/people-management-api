<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="20241912_anna_001_create_person_seq" author="anna">
        <sql>
            create sequence person_seq start with 1 increment by 1
        </sql>

    </changeSet>

    <changeSet id="20241912_anna_002_create_person_table" author="anna">
        <sql>
            CREATE TABLE person (
            id integer default nextval('person_seq') primary key,
            name VARCHAR(50) NOT NULL,
            surname VARCHAR(50) NOT NULL,
            pesel VARCHAR(50) UNIQUE NOT NULL,
            height INT NOT NULL,
            weight INT NOT NULL,
            email VARCHAR(100),
            employed_from DATE,
            current_position VARCHAR(100),
            current_salary INT,
            pension INT,
            years_worked INT,
            university VARCHAR(250),
            academic_year INT,
            course VARCHAR(100),
            scholarship INT,
            dtype VARCHAR(50) NOT NULL,
            version BIGINT NOT NULL);
        </sql>
    </changeSet>

    <changeSet id="20241912_anna_003_create_position_table" author="anna">
        <sql>
            CREATE TABLE position (
            id integer generated by default as identity primary key,
            name VARCHAR(50) NOT NULL,
            date_from DATE,
            date_to DATE,
            salary INT NOT NULL,
            employee_id INT,
            FOREIGN KEY (employee_id) REFERENCES person(id)
            );

        </sql>
    </changeSet>

    <changeSet id="20241912_anna_004_create_user_and_role_seq" author="anna">
        <createSequence sequenceName="user_seq" startValue="1" incrementBy="1"/>
        <createSequence sequenceName="role_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <changeSet id="20241912_anna_005_create_user_table" author="anna">
        <sql>CREATE TABLE users (
            id integer generated by default as identity primary key,
            name VARCHAR(255) NOT NULL,
            password VARCHAR(255) NOT NULL,
            account_locked BOOLEAN DEFAULT FALSE,
            lock_time TIMESTAMP);
        </sql>
    </changeSet>

    <changeSet id="20241912_anna_006_create_roles_table" author="anna">
        <sql>
            CREATE TABLE roles (
            id integer generated by default as identity primary key,
            name VARCHAR(255) NOT NULL UNIQUE
            );
        </sql>
    </changeSet>

    <changeSet id="20241912_anna_007_create_users_roles_table" author="anna">
        <sql>
            create table users_roles
            (
            user_id integer not null,
            role_id integer not null,
            primary key (user_id, role_id)
            );
        </sql>
    </changeSet>


    <changeSet id="20241912_anna_008_create_login_attempt_table" author="anna">
        <sql>
            CREATE TABLE login_attempt (
            id integer generated by default as identity primary key,
            login_time TIMESTAMP NOT NULL,
            successful BOOLEAN NOT NULL,
            user_id INT NOT NULL,
            FOREIGN KEY (user_id) REFERENCES users(id));
        </sql>
    </changeSet>

    <changeSet id="20241912_anna_009_create_import_status_seq" author="anna">
        <createSequence sequenceName="import_status_seq" startValue="1" incrementBy="1"/>
    </changeSet>

    <changeSet id="20241912_anna_010_create_import_status_table" author="anna">
        <sql>
            CREATE TABLE import_status (
            id integer generated by default as identity primary key,
            submit_date TIMESTAMP NOT NULL,
            start_date TIMESTAMP,
            status VARCHAR(50) NOT NULL,
            processed INT NOT NULL
            );
        </sql>
    </changeSet>



    <changeSet id="20241227_anna_012_create_person_position_view" author="anna">
        <sql>
            CREATE VIEW Person_View AS
            SELECT
            p.id,
            p.version,
            p.dtype,
            p.name,
            p.surname,
            p.email,
            p.pesel,
            CASE
            WHEN CAST(RIGHT(p.pesel, 1) AS INT) % 2 = 0 THEN 'm'
            ELSE 'f'
            END AS gender,
            p.weight,
            p.height,
            p.university,
            p.course,
            p.academic_year,
            p.scholarship,
            p.years_worked,
            p.pension,
            p.current_position,
            p.current_salary,
            p.employed_from,
            CASE
            WHEN p.dtype = 'Employee' THEN CAST(COUNT(position.id) AS INTEGER)
            ELSE CAST(NULL AS INTEGER)
            END AS number_of_positions
            FROM
            person p
            LEFT JOIN position ON position.employee_id = p.id
            GROUP BY
            p.id,p.version, p.dtype, p.name, p.surname, p.email, p.pesel, p.weight, p.height,
            p.university, p.course, p.academic_year, p.scholarship, p.years_worked,
            p.pension, p.current_position, p.employed_from, p.current_salary;
        </sql>
    </changeSet>

    <changeSet id="20250116_anna_013_create_distributed_lock_table" author="anna">
        <sql>
            CREATE TABLE distributed_lock (
            lock_key VARCHAR(255) PRIMARY KEY,
            locked_at TIMESTAMP
            );
        </sql>
    </changeSet>

    <changeSet id="20250120_anna_014_change_distributed_lock_table" author="anna">
        <sql>
            ALTER TABLE distributed_lock ADD COLUMN active_imports INT NOT NULL DEFAULT 0;
            ALTER TABLE distributed_lock ADD COLUMN max_imports INT NOT NULL DEFAULT 1;
        </sql>
    </changeSet>
    <changeSet id="20250121_anna_015_remove_locked_at_column" author="anna">
        <sql>
            ALTER TABLE distributed_lock DROP COLUMN locked_at;
        </sql>
    </changeSet>

</databaseChangeLog>